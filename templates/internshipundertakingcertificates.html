<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Undertaking Certificates</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f9fc; padding: 20px; }
    h2 { color: #222; margin-bottom: 20px; }
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-bar select, .filter-bar input { padding: 6px; border: 1px solid #ccc; border-radius: 6px; }
    .filter-btn, .btn { background: #6c63ff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f1f1f1; }
    .status { padding: 4px 10px; border-radius: 12px; font-size: 12px; }
    .ongoing { background: #fff3cd; color: #856404; }
    .completed { background: #d4edda; color: #155724; }
    .dropped { background: #f8d7da; color: #721c24; }
    .generated { background: #cce5ff; color: #004085; }
    .actions a { color: #6c63ff; text-decoration: none; font-size: 14px; }
  </style>
</head>
<body>

<h2>Manage Undertaking Certificates</h2>

<!-- Unified Filter + Generate -->
<form method="get" id="batchFilterForm" class="filter-bar">
  <select id="batch_id" name="batch_id" required>
    <option value="">-- Select Batch --</option>
    {% for batch in batches %}
      <option value="{{ batch.id }}" {% if request.GET.batch_id == batch.id|stringformat:"s" %}selected{% endif %}>
        {{ batch.name }} ({{ batch.course.name }})
      </option>
    {% endfor %}
  </select>

  <input type="text" name="search" placeholder="Search by Name or ID" value="{{ request.GET.search }}">

  <!-- Four buttons side by side -->
  <button type="submit" class="filter-btn" name="action" value="filter">Search</button>
  <button type="button" class="btn" id="generateSingleBtn">Generate Single Certificate</button>
  <button type="button" class="btn" id="generateSelectedBtn">Generate Selected Certificates</button>
  <button type="submit" class="btn" name="action" value="generate_batch">Generate Batch Certificates</button>
</form>

<!-- Interns Table -->
<form method="post" action="{% url 'undertaking_multiple' %}" id="internsForm">
  {% csrf_token %}
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>Intern</th>
        <th>Course</th>
        <th>Batch</th>
        <th>Status</th>
        <th>Certificate</th>
      </tr>
    </thead>
    <tbody>
        {% if interns %}
            {% for intern in interns %}
            <tr>
                <td>
                {% if not intern.undertaking_generated and intern.internship_status == "Ongoing" %}
                    <input type="checkbox" name="intern_ids" value="{{ intern.id }}">
                {% endif %}
                </td>
                <td>{{ intern.user.get_full_name }}<br><small>{{ intern.unique_id }}</small></td>
                <td>{{ intern.batch.course.name }}</td>
                <td>{{ intern.batch.name }}</td>
                <td>
                {% if intern.internship_status == "Ongoing" %}
                    <span class="status ongoing">Ongoing</span>
                {% elif intern.internship_status == "Completed" %} 
                    <span class="status completed">Completed</span>
                {% elif intern.internship_status == "Dropped" %}
                    <span class="status dropped">Dropped</span>
                {% endif %}

                {% if intern.undertaking_generated %}
                    <span class="status generated">Generated</span>
                {% endif %}
                </td>
                <td class="actions">
                {% if not intern.undertaking_generated and intern.internship_status == "Ongoing" %}
                    <a href="{% url 'undertaking_single' identifier=intern.id %}">Generate</a>
                {% else %}
                    <span style="color:#999;">Not Available</span>
                {% endif %}
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
            <td colspan="6" style="text-align:center; color:#666; padding:20px;">
                {% if request.GET.search %}
                    {% if request.GET.search|length > 0 and request.GET.search.isdigit %}
                        üö´ No interns found with <strong>ID "{{ request.GET.search }}"</strong>.
                    {% else %}
                        üö´ No interns found with <strong>Name "{{ request.GET.search }}"</strong>.
                    {% endif %}
                {% elif request.GET.batch_id %}
                    üìå No interns available in the selected batch.
                {% else %}
                    üìå No interns available for the selected filters.
                {% endif %}
            </td>
            </tr>
        {% endif %}
    </tbody>
  </table>
</form>

<script>
  // Select all checkboxes
  document.getElementById("selectAll").addEventListener("change", function() {
    document.querySelectorAll("input[name='intern_ids']").forEach(cb => cb.checked = this.checked);
  });

  // Handle filter vs generate batch
  document.getElementById("batchFilterForm").addEventListener("submit", function(e){
    const batchId = document.getElementById("batch_id").value;
    const action = e.submitter.value; 

    if(action === "generate_batch" && batchId){
      e.preventDefault();
      window.location.href = `/undertaking/batch/${batchId}/`;
    }
  });

  // Generate Selected
  document.getElementById("generateSelectedBtn").addEventListener("click", function(){
    document.getElementById("internsForm").submit();
  });

  // Generate Single
  document.getElementById("generateSingleBtn").addEventListener("click", function(){
    const checked = document.querySelectorAll("input[name='intern_ids']:checked");
    if(checked.length === 1){
      const internId = checked[0].value;
      window.location.href = `/undertaking/single/${internId}/`;
    } else {
      alert("‚ö†Ô∏è Please select exactly ONE intern to generate a single certificate.");
    }
  });
</script>

</body>
</html>
