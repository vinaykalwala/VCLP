{% extends "login_base.html" %}
{% block content %}
{% load static %}
<style>
/* --- General Page Styling --- */
.page-title {
    font-weight: 700;
    color: #5932EA;
}

/* Batch Card */
.batch-card {
    border-radius: 12px;
    border: 1px solid #e0e0e0;
}

/* Scoreboard Table Card */
.scoreboard-card {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

/* Table Styling */
.scoreboard-card table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}

.scoreboard-card thead th {
    background-color: #5932EA;
    color: #ffffff;
    font-weight: 600;
    text-align: center;
    padding: 12px;
    border: 1px solid #d0d0d0;
    vertical-align: middle;
    font-size: 14px;
}

.scoreboard-card tbody td {
    padding: 12px;
    border: 1px solid #e0e0e0;
    vertical-align: middle;
    font-size: 13px;
}

.scoreboard-card tbody tr:nth-child(odd) td {
    background-color: #ffffff !important;
}

.scoreboard-card tbody tr:nth-child(even) td {
    background-color: #f9f9f9 !important;
}

.scoreboard-card tbody tr:hover td {
    background-color: rgba(89, 50, 234, 0.1) !important;
}

.progress-wrapper {
    background-color: #e9e9e9;
    border-radius: 12px;
    height: 24px;
    overflow: hidden;
    position: relative;
}

.progress-bar {
    height: 100%;
    border-radius: 12px 0 0 12px;
}

/* Center the percentage number over the bar */
.progress-text {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    font-size: 0.9rem;
    color: #fff;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

/* Default Box */
.default-box {
    border-radius: 12px;
    border: 2px dashed #5932EA;
    background-color: #fff;
    padding: 40px 20px;
    margin-top: 20px;
}

/* Buttons */
.btn-primary {
    background-color: #5932EA;
    border-color: #5932EA;
}

.btn-primary:hover {
    background-color: #4727B2;
    border-color: #4727B2;
}

/* Analytics Section */
.analytics {
    margin-top: 40px;
}
.analytics h4 {
    color: #5932EA;
    font-weight: 700;
    margin-bottom: 20px;
}
.chart-row-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
}
.chart-box {
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    text-align: center;
}
.analytics-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 40px;
}
.analytics-placeholder img {
    max-width: 420px;
    width: 100%;
    opacity: 0.9;
}
.analytics-placeholder p {
    color: #666;
    margin-top: 10px;
    font-weight: 600;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .batch-card form .col-md-4, .batch-card form .col-md-2 {
        width: 100%;
    }
    .progress-wrapper {
        width: 100%;
    }
    .scoreboard-card table {
        display: block;
        overflow-x: auto;
    }
    .page-title{
      text-align: center;
    }
}
</style>

<div class="main-content">
    <div class="container">

        <!-- Header + Batch Card in same row -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <div>
                <h2 class="page-title">Batch Scores</h2>
                <p class="text-muted">View intern assignment scores and completion rates</p>
            </div>
            <div class="batch-card" style="flex:1 1 300px; margin-left:20px;">
                <div class="card-body p-2">
                    <form method="get" class="d-flex gap-2 align-items-center">
                        <select name="batch_id" id="batch_id" class="form-select" required>
                            <option value="">-- Select Batch --</option>
                            {% for batch in batches %}
                                <option value="{{ batch.id }}" {% if selected_batch and batch.id == selected_batch.id %}selected{% endif %}>
                                    {{ batch.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">Show</button>
                    </form>
                </div>
            </div>
        </div>

        {% if selected_batch %}
        {% if scoreboard %}
        <!-- Scoreboard Card -->
        <div class="card shadow-sm scoreboard-card mb-4">
            <div class="card-header bg-white border-0 text-center">
                <h5 class="mb-0 text-purple" style="padding: 15px 0;">Scores for Batch: {{ selected_batch.name }}</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Intern</th>
                            <th>Total Assignments</th>
                            <th>Submitted</th>
                            <th>Graded</th>
                            <th>Total Score</th>
                            <th>Average Score</th>
                            <th>Completion %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in scoreboard %}
                        <tr>
                            <td>{{ row.intern.user.get_full_name|default:row.intern.unique_id }}</td>
                            <td>{{ row.total_assignments }}</td>
                            <td>{{ row.submitted_count }}</td>
                            <td>{{ row.graded_count }}</td>
                            <td>{{ row.total_score }}</td>
                            <td>{{ row.average_score }}</td>
                            <td>
                                <div class="progress-wrapper">
                                    <div class="progress-bar" 
                                         style="width: {{ row.completion_rate }}%;
                                                background: {% if row.completion_rate < 50 %}#E74C3C
                                                            {% elif row.completion_rate < 80 %}#F39C12
                                                            {% else %}#27AE60
                                                            {% endif %};">
                                    </div>
                                    <div class="progress-text">{{ row.completion_rate }}%</div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="analytics">
            <h4>Performance Analytics</h4>

            <!-- Top Performer Chart Row -->
            <div class="chart-row-2 mb-3">
                <div class="chart-box" style="flex:1 1 100%;">
                    <h6>Top Performer</h6>
                    <canvas id="topPerformerChart"></canvas>
                </div>
            </div>

            <!-- Pie Charts Row -->
            <div class="chart-row-2">
               <div class="chart-box">
    <h6>Average Score Distribution</h6>
    <canvas id="averageScoreChart"></canvas>
</div>

                <div class="chart-box">
                    <h6>Submission Rate</h6>
                    <canvas id="submissionChart"></canvas>
                </div>
            </div>
        </div>

        {% else %}
        <div class="default-box">No submissions found for this batch.</div>
        {% endif %}
        {% else %}
        <div class="card shadow-sm text-center default-box">
            <div class="card-body">
                <h5 class="card-title">Please select a batch to view scores</h5>
                <p class="text-muted">The scoreboard will appear here once a batch is selected.</p>
            </div>
        </div>
        <div class="analytics-placeholder">
                        <p>Analytics will appear here once available.</p>

            <img src="{% static 'images/analytics.png' %}" alt="Analytics Placeholder">
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script>
{% if scoreboard %}
    const topLabels = [{% for row in scoreboard %}'{{ row.intern.user.get_full_name|default:row.intern.unique_id }}',{% endfor %}];
    const topData = [{% for row in scoreboard %}{{ row.total_score }},{% endfor %}];
    const colors = ['#5932EA','#27AE60','#F39C12','#E74C3C','#3498DB','#9B59B6','#1ABC9C','#F1C40F'];
    const barColors = topLabels.map((_, i) => colors[i % colors.length]);

    new Chart(document.getElementById('topPerformerChart'), {
        type: 'bar',
        data: { labels: topLabels, datasets:[{data: topData, backgroundColor: barColors}] },
        options: { plugins:{ legend:{display:false } }, scales:{ y:{ beginAtZero:true } } }
    });

    let totalScoreSecured=0;
    let totalPossibleScore=0;
    let totalSubmitted=0;
    let totalAssignments=0;

    // Pass scoreboard data as JS array
    const scoreboardData = [
        {% for row in scoreboard %}
        {
            total_score: {{ row.total_score }},
            total_assignments: {{ row.total_assignments }},
            submitted_count: {{ row.submitted_count }},
            max_score: {{ row.max_score|default:100 }}
        },
        {% endfor %}
    ];

    scoreboardData.forEach(row => {
        totalScoreSecured += row.total_score;
        totalPossibleScore += row.total_assignments * row.max_score;
        totalSubmitted += row.submitted_count;
        totalAssignments += row.total_assignments;
    });

    let remainingScore = totalPossibleScore - totalScoreSecured;
    let totalPending = totalAssignments - totalSubmitted;

  // Average Score Distribution Pie Chart
const avgScores = scoreboardData.map(r => r.total_score / (r.total_assignments || 1)); // average per intern
const avgLabels = topLabels;

new Chart(document.getElementById('averageScoreChart'), {
    type:'pie',
    data:{ 
        labels: avgLabels, 
        datasets:[{data: avgScores, backgroundColor: barColors}] 
    },
    plugins:[ChartDataLabels],
    options:{ 
        responsive:true, 
        plugins:{ 
            datalabels:{ 
                color:'#fff', 
                formatter:(v,c)=>{
                    let s=c.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); 
                    return ((v/s)*100).toFixed(1)+'%'; 
                }, 
                font:{weight:'bold',size:12}
            }, 
            legend:{ position:'bottom'} 
        } 
    }
});

    new Chart(document.getElementById('submissionChart'), {
        type:'pie',
        data:{ labels:['Submitted','Pending'], datasets:[{data:[totalSubmitted,totalPending], backgroundColor:['#3498DB','#E74C3C']}] },
        plugins:[ChartDataLabels],
        options:{ responsive:true, plugins:{ datalabels:{ color:'#fff', formatter:(v,c)=>{ let s=c.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); return ((v/s)*100).toFixed(1)+'%'; }, font:{weight:'bold',size:12}}, legend:{ position:'bottom'} } }
    });
{% endif %}
</script>

{% endblock %}
